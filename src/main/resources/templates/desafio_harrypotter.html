<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>DesafÃ­o - Harry Potter</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      color: #EAEAEA;
      background: linear-gradient(to bottom, #1e1e3f, #0d0d26);
      position: relative;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      padding-right: 0;
    }

    .background-magic {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
      opacity: 0.6;
    }

    .background-magic::before {
      content: '';
      position: absolute;
      width: 4px;
      height: 4px;
      background: #FFD700;
      box-shadow: 200px 800px #FFD700, 150px 200px #DAA520, 300px 120px #FFC107, 450px 600px #FFD700,
                  50px 900px #DAA520, 250px 300px #FFC107, 400px 450px #FFD700, 100px 550px #DAA520,
                  350px 650px #FFC107, 200px 750px #FFD700, 500px 850px #DAA520, 150px 950px #FFC107;
      animation: magic-float 15s infinite linear;
    }

    .background-magic::after {
      content: '';
      position: absolute;
      width: 3px;
      height: 3px;
      background: #FFC107;
      box-shadow: 100px 100px #DAA520, 220px 400px #FFD700, 400px 500px #FFC107, 10px 700px #DAA520,
                  300px 800px #FFD700, 500px 900px #FFC107;
      animation: magic-float 10s infinite linear 5s;
    }

    @keyframes magic-float {
      0% { transform: translateY(100vh); opacity: 0.5; }
      100% { transform: translateY(-100vh); opacity: 1; }
    }

    .layout {
      width: 100%;
      z-index: 2;
      display: flex;
      flex: 1;
      position: relative;
    }

    .center {
      flex: 1;
      padding: 100px 40px 40px 40px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #EAEAEA;
      position: relative;
      max-width: 700px;
      margin: 0 auto;
    }

    h1 {
      color: #FFD700;
      margin-bottom: 10px;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
      position: relative;
      z-index: 2;
      font-size: 2.6rem;
      letter-spacing: 1.2px;
      font-weight: 700;
    }

    .portada {
      width: 200px;
      height: 280px;
      border-radius: 6px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      background-image: url('/img/harrypotter.jpg');
      background-size: cover;
      background-position: center;
      margin-bottom: 15px;
      border: 3px solid #8e44ad;
      position: relative;
      z-index: 2;
      flex-shrink: 0;
    }

    p {
      max-width: 700px;
      line-height: 1.6;
      color: #CFCFCF;
      font-size: 1rem;
      position: relative;
      z-index: 2;
      margin-bottom: 32px;
    }

    .capitulos {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
      margin-top: 30px;
      margin-bottom: 60px;
      padding-bottom: 100px;
      position: relative;
      z-index: 2;
    }

    .capitulo-nodo {
      width: 85px;
      height: 85px;
      border-radius: 50%;
      background: #8e44ad;
      border: 3px solid #FFD700;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      box-shadow: 0 0 15px rgba(142, 68, 173, 0.5);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      font-size: 1.2rem;
      user-select: none;
    }

    .capitulo-nodo.locked {
      opacity: 0.6;
      cursor: not-allowed;
      background: #5D3FD3;
      border-color: #A0A0A0;
    }

    .capitulo-nodo.locked::after {
      content: "âœ¨";
      position: absolute;
      font-size: 1.2rem;
      opacity: 0.8;
    }

    .capitulo-nodo.leido {
      background: #FFD700;
      color: #333;
      transform: scale(1.1);
      box-shadow: 0 0 20px #FFD700;
    }

    .flecha {
      color: #FFD700;
      margin: 6px 0;
      font-size: 1.2rem;
      opacity: 0.8;
      animation: arrow-pulse 1s infinite alternate;
      user-select: none;
    }

    @keyframes arrow-pulse {
      from { opacity: 0.5; }
      to { opacity: 1; }
    }

    /* Sidebar styling */
    .sidebar {
      width: 270px;
      background: linear-gradient(180deg, #1e1e3f, #0d0d26);
      border-left: 3px solid #FFD700;
      padding: 30px 25px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: #fff;
      border-top-left-radius: 25px;
      border-bottom-left-radius: 25px;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.4);
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      z-index: 90;
      user-select: none;
      transition: transform 0.35s ease;
      transform: translateX(0);
    }
    .sidebar.hide {
      transform: translateX(100%);
    }
    .sidebar h2 {
      text-align: center;
      color: #FFD700;
      font-weight: 700;
      font-size: 1.8rem;
      letter-spacing: 1px;
      margin-bottom: 35px;
      text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
      user-select: none;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
    }
    .sidebar li {
      color: #EAEAEA;
      font-weight: 600;
      font-size: 1.1rem;
      padding: 12px 20px;
      margin: 18px 0;
      border-radius: 14px;
      background: rgba(142, 68, 173, 0.15);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    .sidebar li:hover {
      background: rgba(142, 68, 173, 0.35);
      transform: translateX(-6px);
    }
    .footer {
      color: #7f8c8d;
      font-size: 0.85rem;
      text-align: center;
      margin-top: 20px;
      opacity: 0.8;
      user-select: none;
    }

    /* Header and hamburger button for mobile */
    header {
      background: linear-gradient(180deg, #1e1e3f, #0d0d26);
      color: #fff;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      user-select: none;
    }
    header h1 {
      font-weight: 700;
      font-size: 1.5rem;
    }
    .menu-toggle {
      background: none;
      border: none;
      cursor: pointer;
      width: 28px;
      height: 28px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 0;
    }
    .menu-toggle span {
      display: block;
      height: 3px;
      background: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }
    .menu-toggle.open span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    .menu-toggle.open span:nth-child(2) {
      opacity: 0;
    }
    .menu-toggle.open span:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #F8F8F8;
      padding: 25px;
      border-radius: 10px;
      max-width: 600px;
      text-align: left;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      max-height: 80vh;
      overflow-y: auto;
      color: #222;
    }
    .modal-content h3 {
      color: #5D3FD3;
      margin-bottom: 15px;
      text-align: center;
    }
    .modal-content button {
      background: #8e44ad;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 10px 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 15px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .modal-content button:hover {
      background: #5D3FD3;
    }

    .mensaje-motivacional {
      display: none;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #8e44ad;
      color: #FFD700;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      z-index: 210;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.5s ease;
      border: 2px solid #FFD700;
    }
    .mensaje-motivacional.show {
      display: block;
      opacity: 1;
    }

    /* Responsive for mobile */
    @media (max-width: 900px) {
      header h1 {
        font-size: 1.3rem;
      }
      .sidebar {
        width: 220px;
        height: calc(100vh - 60px);
        border-radius: 0 0 0 25px;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
        top: 60px;
        right: 0;
        position: fixed;
        background: linear-gradient(180deg, #1e1e3f, #0d0d26);
        padding: 25px 20px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        user-select: none;
      }
      .sidebar.show {
        transform: translateX(0);
        z-index: 200;
      }
      .layout {
        flex-direction: column;
        padding-right: 0;
      }
      .center {
        padding: 80px 20px 40px 20px;
        max-width: 100%;
        width: 100%;
      }
      .capitulo-nodo {
        width: 70px;
        height: 70px;
        font-size: 1rem;
      }
      .flecha {
        font-size: 1rem;
        margin: 4px 0;
      }
      p {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>Harry Potter y la piedra filosofal</h1>
  <button aria-label="Abrir menÃº" aria-expanded="false" aria-controls="sidebar" class="menu-toggle" id="menu-toggle" type="button">
    <span></span>
    <span></span>
    <span></span>
  </button>
</header>

<div class="background-magic" aria-hidden="true"></div>

<div class="layout">
  <main class="center" role="main">
    <div class="portada" aria-label="Portada del libro Harry Potter y la piedra filosofal"></div>
    <h1>Harry Potter y la piedra filosofal</h1>
    <p>Un viaje mÃ¡gico que te invita a descubrir el valor de la amistad, el coraje y la magia que vive en cada uno de nosotros.</p>
    <div class="capitulos" id="capitulosList"></div>
  </main>

  <aside id="sidebar" class="sidebar hide" role="navigation" aria-label="MenÃº principal">
    <div>
      <h2>LECTIO</h2>
      <ul>
        <li onclick="location.href='/api/inicio'" tabindex="0" role="link" aria-label="Inicio">Inicio</li>
        <li onclick="location.href='/api/libros'" tabindex="0" role="link" aria-label="Biblioteca">Biblioteca</li>
        <li onclick="location.href='/api/historia_pensamiento'" tabindex="0" role="link" aria-label="Historia del Pensamiento">ðŸ’¡ Historia del Pensamiento</li>
        <li onclick="location.href='/api/logiado'" tabindex="0" role="link" aria-label="Volver a Lectio">Volver a Lectio</li>
      </ul>
    </div>
    <div class="footer">Â© 2025 Lectio</div>
  </aside>
</div>

<div id="modal" class="modal" onclick="if(event.target===this)closeModal()" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-body">
  <div class="modal-content">
    <h3 id="modal-title">CapÃ­tulo</h3>
    <div id="modal-body" style="white-space:pre-wrap;color:#333"></div>
    <button id="modal-button" type="button" onclick="handleModalButtonClick()">Completar</button>
  </div>
</div>

<div id="mensaje" class="mensaje-motivacional" role="alert" aria-live="assertive" aria-atomic="true"></div>

<script>
  const menuToggle = document.getElementById('menu-toggle');
  const sidebar = document.getElementById('sidebar');

  function toggleMenu() {
    const isOpen = sidebar.classList.toggle('show');
    sidebar.classList.toggle('hide', !isOpen);
    menuToggle.classList.toggle('open', isOpen);
    menuToggle.setAttribute('aria-expanded', isOpen.toString());
    if (isOpen) sidebar.focus();
  }

  menuToggle.addEventListener('click', toggleMenu);

  document.addEventListener('click', (e) => {
    if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
      if (sidebar.classList.contains('show')) {
        sidebar.classList.remove('show');
        sidebar.classList.add('hide');
        menuToggle.classList.remove('open');
        menuToggle.setAttribute('aria-expanded', 'false');
      }
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && sidebar.classList.contains('show')) {
      sidebar.classList.remove('show');
      sidebar.classList.add('hide');
      menuToggle.classList.remove('open');
      menuToggle.setAttribute('aria-expanded', 'false');
      menuToggle.focus();
    }
  });

  const capitulos = [
      `CapÃ­tulo 1: El niÃ±o que sobreviviÃ³ y la magia escondida.

En una noche oscura, un anciano con capa pÃºrpura, Albus Dumbledore, y una mujer con forma de gata, la Profesora McGonagall, observaban una casa comÃºn en Privet Drive. En los brazos de un gigante llamado Hagrid, traÃ­an a un bebÃ© con una cicatriz en forma de rayo. Era Harry Potter. Voldemort lo habÃ­a atacado, y el sacrificio de su madre, Lily, habÃ­a dejado una protecciÃ³n mÃ¡gica que nadie comprendÃ­a. Aquella noche, el mundo mÃ¡gico celebrÃ³, sin saber que aquel niÃ±o, dejado a la puerta de sus tÃ­os muggles (los Dursley), cambiarÃ­a el destino de todos. Harry fue depositado con una nota explicando su pasado y su destino. Sin embargo, los Dursley, temerosos de todo lo que fuera "anormal," lo escondieron y lo trataron como un intruso, obligÃ¡ndolo a vivir bajo las escaleras.`,
      `CapÃ­tulo 2: La llamada de Hogwarts.

Harry Potter creciÃ³ creyendo que era un niÃ±o completamente normal, aunque la extraÃ±a suerte lo seguÃ­a a donde fuera. VivÃ­a bajo las escaleras, invisible para los Dursley y acosado por su primo Dudley. Pero al cumplir once aÃ±os, su vida dio un giro radical. Una carta llegÃ³ dirigida a Ã©l, a "La alacena bajo la escalera." Intentaron esconderla, bloquearla, y finalmente, huyeron a una cabaÃ±a en un islote para escapar de la avalancha de correo. Fue allÃ­, en medio de la tormenta, que un gigante llamado Hagrid derribÃ³ la puerta y, con una voz atronadora, le revelÃ³ la verdad: "Eres un mago, Harry." Hagrid le explicÃ³ su historia, la verdad sobre la muerte de sus padres y la existencia de Hogwarts, la escuela de magia y hechicerÃ­a. Harry, aturdido, aceptÃ³ su destino.`,
      `CapÃ­tulo 3: Amistad y la Ceremonia de SelecciÃ³n.

Hagrid llevÃ³ a Harry al CallejÃ³n Diagon, donde comprÃ³ su varita (hermana de la de Voldemort), sus libros y su lechuza, Hedwig. En la estaciÃ³n de King's Cross, Harry encontrÃ³ el andÃ©n 9Â¾ y subiÃ³ al Expreso de Hogwarts. AllÃ­ conociÃ³ a Ronald Weasley, su primer amigo verdadero, y a Hermione Granger, una bruja brillante y algo sabelotodo. Juntos, llegaron al majestuoso Castillo de Hogwarts. En el Gran Comedor, frente a miles de alumnos, el Sombrero Seleccionador deliberÃ³ sobre su destino. Tras un debate interno, el Sombrero gritÃ³: "Â¡Gryffindor!". Harry, Ron y Hermione fueron asignados a la casa del coraje, uniendo fuerzas para lo que serÃ­a el inicio de una amistad eterna.`,
      `CapÃ­tulo 4: El espejo de Oesed y los deseos del corazÃ³n.

La vida en Hogwarts fue emocionante, llena de lecciones de pociones con el temido Snape y partidos de Quidditch. Durante las vacaciones de Navidad, Harry descubriÃ³ un espejo misterioso en una sala abandonada. Al mirarse, no vio su reflejo, sino la imagen de sus padres, sonriÃ©ndole. Se obsesionÃ³ con el espejo, volviendo noche tras noche. El profesor Dumbledore lo encontrÃ³ y, con paciencia, le explicÃ³ la naturaleza del artefacto: "No sirve para mostrarnos la verdad, sino los deseos mÃ¡s profundos y desesperados de nuestro corazÃ³n." Dumbledore le advirtiÃ³ que la felicidad no se encuentra en soÃ±ar con lo que no se puede tener. Harry comprendiÃ³ que la magia mÃ¡s poderosa no eran los hechizos, sino el amor y la conexiÃ³n con sus amigos, que ahora eran su verdadera familia.`,
      `CapÃ­tulo 5: El valor de la amistad y la protecciÃ³n final.

Harry, Ron y Hermione descubrieron que la Piedra Filosofal, capaz de conceder la inmortalidad, estaba escondida en Hogwarts. Creyendo que el Profesor Snape intentaba robarla para Voldemort, decidieron actuar. Juntos, enfrentaron pruebas imposibles bajo el castillo: el perro de tres cabezas, trampas de plantas venenosas, el ajedrez mÃ¡gico gigante de McGonagall y acertijos de pociones. En el Ãºltimo desafÃ­o, Harry se encontrÃ³ cara a cara, no con Snape, sino con el Profesor Quirrell, quien llevaba a Voldemort pegado a su nuca. La protecciÃ³n de su madre se activÃ³. Cuando Quirrell tocÃ³ a Harry, se desvaneciÃ³ en cenizas. La Piedra fue destruida. Dumbledore le dijo despuÃ©s: "No fue tu magia la que te salvÃ³, Harry, fue el amor de tu madre. El amor que te dio es una marca que Voldemort no puede soportar." Harry regresÃ³ a Privet Drive, sabiendo que Hogwarts serÃ­a su hogar para siempre.`
  ];

  const mensajesMotivacionales = [
      "Has dado el primer paso a tu destino. Â¡No dejes que los muggles apaguen la chispa!",
      "Cada carta abre un nuevo camino. Â¡Acepta la llamada de tu propia aventura!",
      "Has encontrado a tu equipo. La amistad es el hechizo mÃ¡s fuerte que existe. Â¡Adelante, Gryffindor!",
      "Mira mÃ¡s allÃ¡ del reflejo: el valor mÃ¡s grande es amar sin obsesiÃ³n. Â¡Tu corazÃ³n es tu mejor brÃºjula!",
      "La aventura ha terminado, pero tu magia interior permanece. Â¡Recuerda, el amor es la magia mÃ¡s poderosa! âš¡"
  ];

  const LIBRO_ID = 'harrypotter';
  const cont = document.getElementById('capitulosList');
  let currentReadingChapterIndex = -1;
  let capitulosLeidos = [];

  async function cargarProgreso() {
      try {
          const response = await fetch('/api/progreso/mi-progreso', {
              method: 'GET',
              credentials: 'include'
          });

          if (!response.ok) {
              desbloquearSiguientes();
              return;
          }

          const data = await response.json();

          if (data.capitulosPorLibro && data.capitulosPorLibro[LIBRO_ID]) {
              capitulosLeidos = Array.from(data.capitulosPorLibro[LIBRO_ID]);
          }

          desbloquearSiguientes();
      } catch (error) {
          desbloquearSiguientes();
      }
  }

  async function guardarProgreso(capituloIndex) {
      try {
          const response = await fetch('/api/progreso/guardar-capitulo', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                  libroId: LIBRO_ID,
                  capitulo: capituloIndex,
                  totalCapitulos: capitulos.length
              })
          });

          if (response.ok) {
              if (capitulosLeidos.length === capitulos.length) {
                  mostrarMensaje('ðŸŽ‰ Â¡Felicitaciones! Has completado Harry Potter. +100 puntos âš¡');
              }
          }
      } catch (error) {
          console.error('Error guardando progreso:', error);
      }
  }

  function renderChapters() {
    capitulos.forEach((txt, i) => {
      const nodo = document.createElement('div');
      nodo.className = 'capitulo-nodo locked';
      nodo.textContent = i + 1;
      nodo.tabIndex = 0;
      nodo.setAttribute('role', 'button');
      nodo.setAttribute('aria-label', `CapÃ­tulo ${i + 1}`);
      nodo.onclick = () => openModal(i);
      nodo.onkeypress = (e) => { if(e.key === 'Enter' || e.key === ' ') openModal(i); };
      cont.appendChild(nodo);

      if (i < capitulos.length - 1) {
        const f = document.createElement('div');
        f.className = 'flecha';
        f.innerHTML = '&#8595;';
        cont.appendChild(f);
      }
    });
  }

  function desbloquearSiguientes() {
    const nodos = document.querySelectorAll('.capitulo-nodo');
    nodos.forEach((n, i) => {
      if (i === 0 || capitulosLeidos.includes(i - 1)) {
        n.classList.remove('locked');
      }
      if (capitulosLeidos.includes(i)) n.classList.add('leido');
    });
  }

  function openModal(i) {
    const nodo = document.querySelectorAll('.capitulo-nodo')[i];
    if (nodo.classList.contains('locked')) return;

    document.getElementById('modal-title').innerText = `CapÃ­tulo ${i + 1}`;
    document.getElementById('modal-body').innerText = capitulos[i];
    const modalButton = document.getElementById('modal-button');
    if (capitulosLeidos.includes(i)) {
      modalButton.innerText = 'Cerrar';
      modalButton.onclick = () => closeModal();
    } else {
      modalButton.innerText = 'Completar';
      modalButton.onclick = () => handleModalButtonClick();
    }

    document.getElementById('modal').style.display = 'flex';
    currentReadingChapterIndex = i;
  }

  function handleModalButtonClick() {
    if (document.getElementById('modal-button').innerText === 'Completar') {
      closeModal();
    } else {
      document.getElementById('modal').style.display = 'none';
    }
  }

  function closeModal() {
    document.getElementById('modal').style.display = 'none';
    const i = currentReadingChapterIndex;
    if (i >= 0 && !capitulosLeidos.includes(i)) {
      capitulosLeidos.push(i);
      guardarProgreso(i);
      mostrarMensaje(mensajesMotivacionales[i % mensajesMotivacionales.length]);
      const nodo = document.querySelectorAll('.capitulo-nodo')[i];
      nodo.classList.add('leido');
      desbloquearSiguientes();
    }
    currentReadingChapterIndex = -1;
  }

  function mostrarMensaje(text) {
    const mensaje = document.getElementById('mensaje');
    mensaje.textContent = text;
    mensaje.classList.add('show');
    setTimeout(() => { mensaje.classList.remove('show'); }, 4000);
  }

  window.onload = () => {
    renderChapters();
    cargarProgreso();
  };
</script>
</body>
</html>
